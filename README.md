# Лабораторная работа №5: LINQ-запросы к базе данных инвестиционных счетов

## Алгоритм

### Шаг 1: Подготовка структуры данных и классов

#### Шаг 1.1: Создание классов-сущностей

Созданы классы для представления таблиц из Excel:
- `Account` (Счет) — содержит ID, ФИО владельца, дату открытия.
- `Currency` (Валюта) — содержит ID валюты и её название.
- `ExchangeRate` (Курс валют) — содержит ID валюты, дату и курс к рублю.
- `Transaction` (Транзакция) — содержит ID, ID счета, ID валюты, дату и сумму.

#### Шаг 1.2: Реализация методов `ToString()`

Для каждого класса переопределён метод `ToString()` для удобного отображения в консоли:
- Форматирование дат в формат `"дд.мм.гггг"`.
- Вывод всех полей объекта в читаемом виде.

#### Шаг 1.3: Создание основного сервиса

Создан класс `BankService` с коллекциями для хранения данных:
- Инициализированы пустые списки в конструкторе.
- Реализованы свойства для доступа к коллекциям.
- Добавлены базовые операции для счетов.

---

### Шаг 2: Работа с Excel-файлами

#### Шаг 2.1: Загрузка данных из Excel

Создан статический класс `ExcelHelper`:
- Реализован метод `LoadFromExcel()`:
  - Поочередное чтение листов: `"Счета"`, `"Валюты"`, `"Курсы валют"`, `"Поступления"`.
  - Парсинг значений ячеек с учётом форматов (даты, числа).
  - Создание объектов и добавление их в `BankService`.
  - Обработка ошибок.

#### Шаг 2.2: Сохранение данных в Excel

Реализован метод `SaveToExcel()`:
- Создание нового `Workbook`.
- Заполнение листов данными из коллекций.
- Создание заголовков столбцов.

#### Шаг 2.3: Обработка ошибок

Добавлены проверки:
- Существование файла.
- Наличие всех необходимых листов.
- Обработка исключений при парсинге.

---

### Шаг 3: Реализация запросов LINQ

#### Шаг 3.1: Запрос к одной таблице — счета, открытые в январе 2021

- Использование метода `Where()` для фильтрации по дате.
- Условие: `OpenDate.Month == 1 && OpenDate.Year == 2021`.
- Возврат коллекции.

#### Шаг 3.2: Запрос к двум таблицам — транзакции с суммой > 4 в рублях

- Соединение `Transactions` с `ExchangeRate` по `CurrencyID` и `Date`.
- Вычисление в рублях: `Amount * Rate`.
- Проверка условия: `rub > 4m`.
- Возврат кортежей: `(транзакция, рублях`).

#### Шаг 3.3: Запрос к трём таблицам — владелец счёта с максимальными начислениями

- Соединение `Transactions` с `ExchangeRate` по `CurrencyID` и `Date`.
- Соединение результата с `Accounts` по `AccountID`.
- Группировка по владельцу счёта.
- Для каждой группы вычисление суммы.
- Сортировка по убыванию суммы.
- Выбор первого владельца (максимальный доход).

#### Шаг 3.4: Запрос к трём таблицам — счета с отрицательным балансом на дату

- Фильтрация транзакций по заданной дате.
- Соединение с курсами валют.
- Группировка по ID счёта.
- Для каждой группы вычисление баланса.
- Фильтрация счетов с балансом `< 0`.
- Соединение с таблицей счетов для получения ФИО.
- Возврат кортежей: `(ID, ФИО, баланс)`.

---

### Шаг 4: Создание менеджера базы данных

#### Шаг 4.1: Класс `DatabaseManager`

Создан класс для управления данными:
- Поле для хранения `BankService`.
- Поле для хранения пути к загруженному файлу.
- Методы загрузки и сохранения данных.

#### Шаг 4.2: Методы отображения данных

Реализованы методы для вывода в консоль:
- `PrintAllAccounts()` — все счета.
- `PrintAllCurrencies()` — все валюты.
- `PrintAllExchangeRates()` — все курсы.
- `PrintAllTransactions()` — все транзакции.

#### Шаг 4.3: Методы для запросов

Созданы методы для запросов из `BankService`:
- Проверка, что данные загружены.
- Возврат результатов или пустых коллекций.
- Обработка исключительных ситуаций.

<img width="1166" height="1128" alt="image" src="https://github.com/user-attachments/assets/f63275d4-81ea-48bd-b44c-1548a887fe55" />
<img width="1049" height="682" alt="image" src="https://github.com/user-attachments/assets/82f6c561-520f-4c81-9d75-8b13ce0aa9a2" />
<img width="1041" height="594" alt="image" src="https://github.com/user-attachments/assets/d6c96310-ca56-4233-903a-07a97a89dcf0" />
<img width="1176" height="729" alt="image" src="https://github.com/user-attachments/assets/3631e2c0-80ff-49be-b046-054511935183" />
<img width="807" height="119" alt="image" src="https://github.com/user-attachments/assets/bb07b56e-1a23-4f59-a0a4-b1ef7eee4a66" />
<img width="791" height="672" alt="image" src="https://github.com/user-attachments/assets/2372ce7f-2a2b-4b90-be48-c01590f8964b" />








